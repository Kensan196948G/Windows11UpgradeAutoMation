# Windows 10 to Windows 11 Upgrade Automation Scripts

## 概要

このプロジェクトは、Windows 10 から Windows 11 へのアップグレードプロセスを自動化するための一連のスクリプトを提供します。これらのスクリプトは、アップグレードの事前チェック、Windows Update を利用したアップグレードの実行、およびアップグレード後のクリーンアップ作業を支援することを目的としています。

## 特徴

*   **ISOイメージ不要:** Windows Update 経由で Windows 11 へのアップグレードを実行します。
*   **事前判定機能:** アップグレード前に、ディスク空き容量、TPM 2.0、メモリ容量、UEFIセキュアブートといった主要なシステム要件を確認します。
*   **詳細なログ出力:** 実行ステータスとエラー情報を指定されたログファイル (`C:\kitting\UpgradeLog`) に記録します。
*   **事後クリーンアップ:** アップグレード後には、ディスククリーンアップ、システムファイルのクリーンアップ、および最終的なWindows Updateの適用を試みます。
*   **モジュール化されたスクリプト:** 各機能（HDDチェック、アップグレード実行、クリーンアップ）は個別のPowerShellスクリプトファイル (`.ps1`) としてモジュール化されており、メインスクリプト (`Win11Upgrade.ps1`) から呼び出されます。

## ファイル構成

本ソリューションは以下のファイルで構成されます。

*   **`StartUpgrade.bat`**:
    アップグレードプロセス全体を開始するバッチファイルです。`Win11Upgrade.ps1` を管理者権限で実行します。
*   **`Win11Upgrade.ps1`**:
    アップグレード処理全体の流れを制御するメインのPowerShellスクリプトです。各モジュールスクリプトを順次呼び出し、処理のログを記録します。
*   **`CheckHDD.ps1`**:
    `Log-HDDStatus` 関数を提供し、ディスクの空き容量や使用状況をログに記録します。`Win11Upgrade.ps1` からアップグレード前後に呼び出されます。
*   **`DoUpgrade.ps1`**:
    `Test-UpgradePrerequisites` 関数と `Start-WindowsUpgrade` 関数を提供します。
    *   `Test-UpgradePrerequisites`: Windows 11へのアップグレードが可能かどうか、システムの前提条件（ディスクスペース、TPM、メモリ、セキュアブート）をチェックします。
    *   `Start-WindowsUpgrade`: `PSWindowsUpdate` モジュールを利用して、Windows Update経由でWindows 11へのアップグレードを検索し、開始します。
*   **`CleanupAndUpdate.ps1`**:
    `Invoke-PostUpgradeTasks` 関数を提供します。この関数は、OSアップグレード後にディスククリーンアップ (`cleanmgr.exe`)、システムファイルクリーンアップ (`Dism.exe`)、および最終的なWindows Updateの確認と自動再起動を伴うインストールを実行します。
*   **`README.md`**:
    このファイルです。プロジェクトの概要、使用方法、注意事項などを記載しています。
*   **`Specification.md`**:
    (旧 `正式仕様書.md`) スクリプト群のより詳細な技術的仕様や動作について記述したドキュメントです。
*   **`OperationManual.md`**:
    (旧 `運用手順書.md`) スクリプトの運用に関する手順やトラブルシューティング情報について記述したドキュメントです。

## 前提条件

スクリプトが正常に動作するためには、以下の環境や設定が必要です。

*   **対象OS:** Windows 10 (アップグレード元)
*   **TPM:** TPM 2.0 が有効であること (警告のみ、アップグレード自体は続行される可能性があります)。
*   **ディスク空き容量:** Cドライブに十分な空き容量が必要です (`DoUpgrade.ps1` 内の `Test-UpgradePrerequisites` 関数でチェック、デフォルトでは256GB中205GB未満の使用量が目安)。
*   **メモリ:** 8GB以上のRAM (警告のみ、アップグレード自体は続行される可能性があります)。
*   **ファームウェア:** UEFIでセキュアブートが有効であること (必須)。
*   **管理者権限:** スクリプトの実行には管理者権限が必要です (`StartUpgrade.bat` が昇格を試みます)。
*   **インターネット接続:** Windows Update および `PSWindowsUpdate` モジュールのダウンロード・インストールに必要です。
*   **`PSWindowsUpdate` モジュール:** `DoUpgrade.ps1` および `CleanupAndUpdate.ps1` スクリプト内で自動的にインストールが試みられますが、事前に手動でインストールしておくとスムーズです。
    ```powershell
    Install-Module PSWindowsUpdate -Force -Scope AllUsers -SkipPublisherCheck
    ```
*   **PowerShell実行ポリシー:** `StartUpgrade.bat` が `ExecutionPolicy Bypass` を指定してPowerShellスクリプトを実行しますが、組織のセキュリティポリシーによる制限がないことを確認してください。
*   **`cleanmgr.exe` の設定:** `CleanupAndUpdate.ps1` 内の `cleanmgr.exe /sagerun:1` が期待通りに動作するためには、事前に `cleanmgr.exe /sageset:1` を実行してクリーンアップ対象を設定しておく必要があります (詳細は注意事項を参照)。

## 使用方法

### 1. 準備段階
*   **ファイルの配置:** 提供されている全てのスクリプトファイル (`.bat`, `.ps1`) およびドキュメントファイル (`.md`) を、クライアントPCの任意の同一ディレクトリに配置してください (例: `C:\Work\Win11Upgrade`)。
*   **バックアップの推奨:** **重要:** アップグレードプロセスを開始する前に、必ず対象PCの重要なデータのバックアップを取得してください。不測の事態によりデータが失われる可能性があります。

### 2. 実行手順
*   配置したディレクトリ内の `StartUpgrade.bat` ファイルを右クリックし、「管理者として実行」を選択します。
*   UAC（ユーザーアカウント制御）のプロンプトが表示された場合は、「はい」を選択します。
*   `StartUpgrade.bat` は、新しいPowerShellウィンドウを管理者権限で開き、`Win11Upgrade.ps1` スクリプトを実行します。元のバッチファイルのウィンドウは閉じても構いません。

### 3. ログの確認方法
*   スクリプトの実行状況、成功、エラーは `C:\kitting\UpgradeLog` ディレクトリ内の以下のファイルに記録されます。
    *   `UpgradeStatus_<日付時刻>.log`: 主要な処理ステップのステータスと情報メッセージ。
    *   `UpgradeError_<日付時刻>.log`: エラー発生時の詳細情報。
*   問題が発生した場合は、これらのログファイルを確認してください。

### 4. アップグレード後処理に関する注意点
*   `Win11Upgrade.ps1` スクリプトは、Windows 11 へのアップグレードを開始した後、連続してアップグレード後のクリーンアップ処理 (`Invoke-PostUpgradeTasks`) を実行しようと試みます。
*   しかし、OSのアップグレードプロセスには通常、複数回の自動再起動が伴います。これにより、`Win11Upgrade.ps1` スクリプトの実行は途中で中断される可能性が高いです。
*   **アップグレードが完了し、Windows 11 が正常に起動した後、アップグレード後のクリーンアップ処理（ディスククリーンアップ、DISMコマンド、最終Windows Update）を確実に実行するためには、再度 `StartUpgrade.bat` を管理者として手動で実行してください。**
*   スクリプトは、`Win11Upgrade.ps1` の再実行時に、アップグレード済みであることを（理想的には）検出し、未完了のアップグレード後処理のみを実行するよう設計されるべきですが、現在のバージョンでは主に連続実行を試みます。手動での再実行が最も確実な後処理の方法です。

## 注意事項

*   **免責事項:** これらのスクリプトは現状のまま提供され、いかなる保証も伴いません。スクリプトの使用は自己責任で行ってください。作成者は、これらのスクリプトの使用によって生じたいかなる損害についても責任を負いません。
*   **バックアップ:** **繰り返しになりますが、スクリプト実行前には必ずシステムの完全なバックアップを取得してください。**
*   **プロキシ環境:** プロキシサーバーを経由してインターネットに接続している環境では、`PSWindowsUpdate` モジュールのインストールやWindows Updateの実行が失敗する場合があります。PowerShellのセッションやシステム全体でプロキシ設定が正しく構成されていることを確認してください。
    ```powershell
    # 例: PowerShellセッションのプロキシ設定
    # $ProxyServer = "http://yourproxy.example.com:port"
    # [System.Net.WebRequest]::DefaultWebProxy = New-Object System.Net.WebProxy($ProxyServer)
    # [System.Net.WebRequest]::DefaultWebProxy.BypassProxyOnLocal = $true
    ```
*   **`cleanmgr.exe /sageset:1` の事前設定:**
    `CleanupAndUpdate.ps1` スクリプト内のディスククリーンアップ処理 (`cleanmgr.exe /sagerun:1`) は、事前に `sageset:1` で定義された設定に基づいて動作します。効果的なクリーンアップを行うためには、アップグレード前に、または展開の一環として、管理者コマンドプロンプトで以下のコマンドを実行し、クリーンアップする項目（例: 一時ファイル、古いWindowsのインストールファイルなど）を選択しておくことを強く推奨します。
    ```cmd
    cleanmgr.exe /sageset:1
    ```
    この設定はPCごとに保存されます。
*   **テスト:** 運用環境に展開する前に、必ずテスト環境で十分に検証を行ってください。
*   **カスタマイズ:** 各PowerShellスクリプト内の設定値（ディスク容量の閾値など）やコマンドは、必要に応じて環境に合わせて調整してください。

---
このドキュメントが、Windows 11へのアップグレード作業の一助となれば幸いです。
