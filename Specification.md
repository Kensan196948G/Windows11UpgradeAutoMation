# Windows 10 → Windows 11（24H2）アップグレード自動化スクリプト 仕様書

## 1. 概要

本文書は、Windows 10 から Windows 11 (バージョン 24H2 を想定) へのインプレースアップグレード処理を自動化するために開発されたPowerShellスクリプト群（以下、本スクリプト群）の技術的な仕様を定義するものです。本スクリプト群は、アップグレードの事前条件チェック、Windows Update を介したアップグレードの実行、およびアップグレード後のシステムクリーンアップと最終的な更新適用までの一連のプロセスを自動化することを目的とします。

## 2. 動作環境

本スクリプト群の実行および Windows 11 へのアップグレードには、以下の動作環境が前提となります。

*   **対象OS:** Windows 10 Pro 最新版（バージョン 22H2 以降を推奨）
*   **TPM (Trusted Platform Module):** バージョン 2.0 が必須です。本スクリプト群に含まれる `Test-UpgradePrerequisites` 関数によりチェックが行われます。
*   **ストレージ空き容量:**
    *   Cドライブの総容量が256GBであると想定し、そのうち使用量が205GB（約80%）以上の場合、アップグレードはスキップされます。
    *   最低でも25GB以上の空き容量が推奨されますが、上記の使用率基準で判定されます。
    *   本スクリプト群に含まれる `Test-UpgradePrerequisites` 関数によりチェックが行われます。
*   **メモリ (RAM):** 8GB以上を推奨します。8GB未満の場合、ステータスログに警告が記録されますが、アップグレード処理自体は続行される可能性があります。本スクリプト群に含まれる `Test-UpgradePrerequisites` 関数によりチェックが行われます。
*   **ファームウェアとセキュアブート:** UEFIファームウェアモードで、セキュアブートが有効であることが必須です。これらの条件を満たさない場合、アップグレードはスキップされます。本スクリプト群に含まれる `Test-UpgradePrerequisites` 関数によりチェックが行われます。
*   **管理者権限:** 本スクリプト群の実行には、ローカルPCの管理者権限が必須です。`StartUpgrade.bat` が実行時に管理者権限への昇格を試みます。
*   **インターネット接続:** Windows Update サービスへの接続、`PSWindowsUpdate` モジュールのダウンロード・インストール、および Windows 11 アップグレードデータのダウンロードのために必須です。
*   **PowerShellモジュール:** `PSWindowsUpdate` モジュールが必要です。本スクリプト群 (`DoUpgrade.ps1`, `CleanupAndUpdate.ps1`) 内で、モジュールが存在しない場合に自動的にインストールが試行されます。

## 3. アップグレード方法

本スクリプト群は、Windows 11 へのアップグレードに際して、以下の方法を採用しています。

*   **ダウンロード方式 (Windows Update経由):**
    ISOイメージファイルや展開されたインストールメディアを使用せず、Microsoft の Windows Update サービスから直接 Windows 11 のアップグレードパッケージをダウンロードしてインストールする方式です。
*   **`PSWindowsUpdate` モジュールの利用:**
    アップグレードパッケージの検索、ダウンロード、およびインストールの制御には、サードパーティ製の PowerShell モジュールである `PSWindowsUpdate` を利用します。具体的には、`DoUpgrade.ps1` スクリプト内の `Start-WindowsUpgrade` 関数が、このモジュールが提供するコマンドレット（例: `Get-WindowsUpdate`, `Install-WindowsUpdate` に相当する処理）を呼び出してアップグレードプロセスを開始します。

## 4. アップグレード判定ロジック

Windows 11 へのアップグレードが可能かどうかを判定するため、`DoUpgrade.ps1` スクリプト内に `Test-UpgradePrerequisites` 関数が実装されています。この関数は以下の項目をチェックし、結果に基づいてアップグレード処理を続行するか、スキップするかを決定します。

| 判定項目             | 判定条件                                     | 対応内容                                                                 |
| -------------------- | -------------------------------------------- | ------------------------------------------------------------------------ |
| ストレージ空き容量不足 | Cドライブ使用容量 > 205GB (総容量256GBの場合) | アップグレード処理をスキップし、エラーログに詳細を記録します。                 |
| TPMバージョン        | TPMのバージョンが2.0未満、またはTPMが準備できていない | ステータスログに警告を記録します。この項目のみではアップグレードはスキップされません。 |
| メモリ不足           | 物理メモリ容量 < 8GB                          | ステータスログに警告を記録します。この項目のみではアップグレードはスキップされません。 |
| UEFI/セキュアブート  | UEFIモードでない、またはセキュアブートが無効     | アップグレード処理をスキップし、エラーログに詳細を記録します。                 |

## 5. ログ出力仕様

本スクリプト群の実行状況やエラー情報は、以下の仕様でログファイルに出力されます。

*   **ログ出力共通パス:** `C:\kitting\UpgradeLog`
    *   このディレクトリは、メインスクリプト `Win11Upgrade.ps1` の実行時に自動的に作成されます。

*   **通常ログ (ステータスログ):**
    *   ファイル名: `UpgradeStatus_<yyyyMMddHHmm>.log` (例: `UpgradeStatus_202403151030.log`)
    *   エンコーディング: UTF-8
    *   出力内容:
        *   **アップグレード前後のHDD使用状況:** `CheckHDD.ps1` の `Log-HDDStatus` 関数によって記録されます。フォーマットは以下の通りです。
            ```
            <ヘッダー文字列 例: "アップグレード前 HDD状態" または "アップグレード後 HDD状態およびクリーンアップ">
            ホスト名：<実行PCのホスト名>
            ユーザー名：<スクリプト実行ユーザー名>
            全HDD容量：<xxx> GB (Cドライブの総容量をGB単位で整数表示、小数点以下切り捨て)
            使用容量：<yyy> GB (Cドライブの使用容量をGB単位で整数表示、小数点以下切り捨て)
            空き容量：<zzz> GB (Cドライブの空き容量をGB単位で整数表示、小数点以下切り捨て)
            使用率　：<使用率>% (Cドライブの使用率をパーセントで整数表示、小数点以下切り捨て)
            ```
        *   **各処理ステップの実行メッセージ:** スクリプトの主要な処理（モジュールのインポート、各チェックの開始・終了、関数の呼び出し結果など）に関する情報メッセージや警告メッセージが、タイムスタンプと共に記録されます。
            例: `[2024/03/15 10:31:05] 前提条件チェックを開始します...`

*   **エラーログ:**
    *   ファイル名: `UpgradeError_<yyyyMMddHHmm>.log` (例: `UpgradeError_202403151035.log`)
    *   エンコーディング: UTF-8
    *   出力内容: スクリプト実行中にエラーが発生した場合、以下のフォーマットで詳細情報が記録されます。
        ```
        発生時刻　：<yyyy/MM/dd HH:mm:ss> (エラー発生時のタイムスタンプ)
        ホスト名　：<実行PCのホスト名>
        ユーザー名：<スクリプト実行ユーザー名>
        スクリプト：<エラーが発生したPowerShellスクリプトファイル名 または 呼び出し元の関数名>
        エラー内容：<発生した例外のメッセージや、エラーの原因に関する詳細な説明>
        対応状況　：<エラー発生後のスクリプトの動作（例: リトライ、スキップ、中断、継続）>
        ```

## 6. アップグレード後処理

Windows 11 へのOSアップグレードが完了した後、`CleanupAndUpdate.ps1` スクリプト内の `Invoke-PostUpgradeTasks` 関数によって、以下の後処理が実行されます。

1.  **ディスククリーンアップ (`cleanmgr.exe`):**
    *   コマンド: `cleanmgr.exe /sagerun:1 /verylowdisk`
    *   動作: 事前に `cleanmgr.exe /sageset:1` コマンドで設定された内容に基づいてディスククリーンアップを実行します。`/verylowdisk` オプションは、利用可能なすべてのクリーンアップオプションを自動的に選択するものではなく、主にディスク容量が極端に少ない状況で実行されることを意図したものです。効果的なクリーンアップのためには、`sageset:1` での事前設定が強く推奨されます。
2.  **システムファイルのクリーンアップ (`Dism.exe`):**
    *   コマンド: `Dism.exe /Online /Cleanup-Image /StartComponentCleanup /ResetBase`
    *   動作: Windows のコンポーネントストアをクリーンアップし、不要になったシステムファイルを削除してディスク領域を解放します。`/ResetBase` オプションは、置き換えられたコンポーネントの古いバージョンをすべて削除します。
3.  **最終的なWindows Update適用:**
    *   コマンド: `Get-WindowsUpdate -Install -AcceptAll -AutoReboot` (`PSWindowsUpdate` モジュールを使用)
    *   動作: OSアップグレード後にリリースされた可能性のある最新のセキュリティ更新プログラムや累積更新プログラムをすべて検索し、適用します。`-AutoReboot` オプションにより、更新の適用後に再起動が必要な場合は自動的に再起動が実行されます。
4.  **アップグレード後HDD使用状況ログ取得:**
    *   動作: `CheckHDD.ps1` の `Log-HDDStatus` 関数を再度呼び出し、アップグレードおよびクリーンアップ処理後の最終的なディスク使用状況をステータスログに記録します。

## 7. 実行ファイル構成

本自動化ソリューションは、以下のスクリプトファイルおよびドキュメントファイルで構成されます。

*   **`StartUpgrade.bat`**:
    *   PowerShellスクリプト `Win11Upgrade.ps1` を管理者権限で起動するためのバッチファイルです。UAC昇格処理を行い、適切な実行ポリシーでPowerShellを呼び出します。
*   **`Win11Upgrade.ps1`**:
    *   メインの処理スクリプトです。全体の処理フロー（事前チェック、アップグレード実行、事後処理の呼び出し）を制御し、詳細なログ出力（ステータスログ、エラーログ）を行います。
*   **`CheckHDD.ps1`**:
    *   `Log-HDDStatus` 関数を実装するPowerShellスクリプトモジュールです。この関数は、呼び出し元の指定に従ってディスクの使用状況をステータスログに記録します。
*   **`DoUpgrade.ps1`**:
    *   `Test-UpgradePrerequisites` 関数と `Start-WindowsUpgrade` 関数を実装するPowerShellスクリプトモジュールです。
        *   `Test-UpgradePrerequisites`: Windows 11 へのアップグレード前提条件（ディスク空き容量、TPM、メモリ、UEFIセキュアブート）を検証します。
        *   `Start-WindowsUpgrade`: `PSWindowsUpdate` モジュールを利用して、Windows Update経由でのWindows 11アップグレードを検索し、開始します。
*   **`CleanupAndUpdate.ps1`**:
    *   `Invoke-PostUpgradeTasks` 関数を実装するPowerShellスクリプトモジュールです。OSアップグレード後のシステムクリーンアップ（`cleanmgr.exe`, `Dism.exe`）、最終的なWindows Updateの適用、および最終ディスク状況のログ記録を行います。
*   **`README.md`**:
    *   本スクリプト群の利用者向けガイドです。目的、機能、ファイル構成、前提条件、使用方法、注意事項などを記載しています。
*   **`Specification.md`**: (本文書)
    *   本スクリプト群の技術的な仕様、動作詳細、ロジックなどを記述したドキュメントです。
*   **`OperationManual.md`**:
    *   本スクリプト群の運用に関する詳細な手順、トラブルシューティング、カスタマイズ例などを記述するドキュメントです。

## 8. バックアップの推奨事項

**重要:** アップグレードプロセスを開始する前に、必ず対象PCの重要なデータのバックアップを取得してください。不測の事態によりデータが失われる可能性があります。システム全体のバックアップ（システムイメージバックアップなど）または、少なくともユーザードキュメント、写真、その他の重要な個人ファイルのバックアップを外部ストレージメディアやネットワーク上の安全な場所に作成することを強く推奨します。

## 9. 実行に関する重要な注意点

*   **再起動処理について:**
    Windows Update を利用したOSのアップグレードプロセス中には、システムが複数回自動的に再起動されることが一般的です。メインスクリプトである `Win11Upgrade.ps1` は、これらのOS再起動を跨いで自動的に処理を継続するようには設計されていません。つまり、アップグレードが開始され、最初の再起動が発生した時点で、`Win11Upgrade.ps1` スクリプトの実行は中断されます。
*   **アップグレード後の手動操作について:**
    Windows 11 へのアップグレードが正常に完了し、OSが起動した後、アップグレード後処理（ディスククリーンアップ、システムファイルクリーンアップ、最終的なWindows Update適用、および最終的なHDD使用状況ログの取得）を確実に実行するためには、**再度 `StartUpgrade.bat` を管理者として手動で実行する必要があります。**
    `Win11Upgrade.ps1` スクリプトは、初回実行時にアップグレードが開始された場合、OS再起動によって後続のクリーンアップ処理が実行される前に中断されることを想定しています。再実行時には、スクリプトが（理想的には）OSバージョンなどを確認し、未実行の後処理タスクのみを識別して実行するべきですが、現在の実装では主に連続実行を試みる形となっており、OS再起動を挟む場合は手動での再実行が後処理を完了させるための最も確実な手段となります。
*   **`cleanmgr.exe /sageset` の事前設定について:**
    `CleanupAndUpdate.ps1` スクリプト内の `Invoke-PostUpgradeTasks` 関数は、ディスククリーンアップのために `cleanmgr.exe /sagerun:1` コマンドを実行します。このコマンドは、事前に `cleanmgr.exe /sageset:1` コマンドによって保存された設定に基づいて動作します。`sageset` 設定が行われていない場合、`sagerun` は期待通りのクリーンアップ項目（例: Windows Updateのクリーンアップ、一時ファイル、古いOSの残骸など）を実行しない可能性があります。
    したがって、本スクリプト群を使用して効果的なディスククリーンアップを行うためには、**事前に各対象PCで管理者として `cleanmgr.exe /sageset:1` を実行し、クリーンアップしたい項目（特に「以前のWindowsのインストール」や「Windows Updateのクリーンアップ」など）を選択して保存しておくことを強く推奨します。** この設定はPCごとに保持されます。

---
本書の内容は、予告なく変更される場合があります。最終更新日: 2024/03/15 (プレースホルダー)
